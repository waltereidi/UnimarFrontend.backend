name: Deploy Local Runner .NET 8

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build_and_deploy:
    name: Build & Deploy (.NET 8)
    runs-on: self-hosted
    environment: production

    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configurar .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restaurar dependências
        run: dotnet restore UnimarFrontend.backend.sln

      - name: Compilar solução
        run: dotnet build UnimarFrontend.backend.sln -c Release --no-restore

      - name: Publicar aplicação
        run: dotnet publish UnimarFrontend.backend.sln -c Release -o ./publish --no-build

      - name: Deploy local
        env:
          DEPLOY_PATH: ${{ vars.PATH }}
        run: |
          echo "Iniciando deploy local..."
          echo "Usando diretório: $DEPLOY_PATH"

          sudo mkdir -p "$DEPLOY_PATH"
          sudo cp -r ./publish/* "$DEPLOY_PATH/"

          echo "Reiniciando serviço..."
          sudo systemctl restart dotnet-app.service
          echo "✅ Deploy finalizado com sucesso!"
